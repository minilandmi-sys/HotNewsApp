import streamlit as st
import feedparser
import pandas as pd
from datetime import datetime
import time
from io import BytesIO

# 4 å€‹ç¶²ç«™çš„ RSS
RSS_FEEDS = {
    "å¦æ–°è": "https://www.niusnews.com/feed",
    "Women's Health TW": "https://www.womenshealthmag.com/tw/rss/all.xml",
    "BEAUTYç¾äººåœˆ": "https://www.beauty321.com/feed_pin",
    "A Day Magazine": "https://www.adaymag.com/feed"
}

def parse_entries(entries):
    parsed_list = []
    for entry in entries:
        published_time = None
        if hasattr(entry, "published_parsed") and entry.published_parsed:
            published_time = datetime(*entry.published_parsed[:6])
        elif hasattr(entry, "updated_parsed") and entry.updated_parsed:
            published_time = datetime(*entry.updated_parsed[:6])
        if not published_time:
            published_time = datetime.now()

        parsed_list.append({
            "æ¨™é¡Œ": entry.title if "title" in entry else "(ç„¡æ¨™é¡Œ)",
            "é€£çµ": entry.link if "link" in entry else "",
            "ç™¼ä½ˆæ™‚é–“": published_time.strftime("%Y-%m-%d %H:%M"),
            "ä¾†æº": ""
        })
    return parsed_list

def fetch_top5_each_site():
    all_entries = []
    for site, url in RSS_FEEDS.items():
        feed = feedparser.parse(url)
        if not feed.entries:
            continue

        entries = parse_entries(feed.entries)
        entries_sorted = entries[:5]
        for item in entries_sorted:
            item["ä¾†æº"] = site
        all_entries.extend(entries_sorted)

        time.sleep(1)

    all_entries.sort(key=lambda x: x["ç™¼ä½ˆæ™‚é–“"], reverse=True)
    return pd.DataFrame(all_entries)

# ================= Streamlit UI =================
st.title("ğŸ“° ç†±é–€æ–°èå ±è¡¨å·¥å…· (RSS)")

if st.button("ğŸ“Š ç”¢ç”Ÿæœ€æ–°å ±è¡¨"):
    df = fetch_top5_each_site()
    if df.empty:
        st.warning("âš ï¸ æ²’æœ‰æŠ“åˆ°ä»»ä½•æ–‡ç« ã€‚")
    else:
        st.success("âœ… å ±è¡¨å·²ç”¢ç”Ÿï¼")
        st.dataframe(df)

        # è½‰æ›ç‚º Excel ä¸¦ä¸‹è¼‰
        output = BytesIO()
        with pd.ExcelWriter(output, engine="openpyxl") as writer:
            df.to_excel(writer, index=False)
        excel_data = output.getvalue()

        today = datetime.now().strftime("%Y-%m-%d")
        filename = f"{today}_HotNews.xlsx"

        st.download_button(
            label="â¬‡ï¸ ä¸‹è¼‰ Excel å ±è¡¨",
            data=excel_data,
            file_name=filename,
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
